"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.handler = void 0;
const aws_sdk_1 = require("aws-sdk");
const cloudevents_1 = require("cloudevents");
const x509_1 = require("@fidm/x509");
const iot = new aws_sdk_1.Iot();
exports.handler = async (event) => {
    console.log(event);
    const requestedCloudEvent = new cloudevents_1.CloudEvent(event);
    const deviceID = requestedCloudEvent.data.device_id;
    const deviceCert = Buffer.from(requestedCloudEvent.data.device_cert, "base64").toString("utf-8");
    const caCert = Buffer.from(requestedCloudEvent.data.ca_cert, "base64").toString("utf-8");
    const status = requestedCloudEvent.data.status;
    const serialNumber = requestedCloudEvent.data.serial_number;
    if (status === "ACTIVE" || status === "INACTIVE" || status === "REVOKED") {
        const searchResponse = await iot.searchIndex({ queryString: `thingName:${deviceID}` }).promise();
        if (searchResponse.things.length === 0) {
            console.log("No results with device ID (" + deviceID + "). Registering device");
            await iot.createThing({ thingName: deviceID }).promise();
            const registerCertificateResponse = await iot.registerCertificate({ certificatePem: deviceCert, caCertificatePem: caCert, status: status }).promise();
            await iot.attachThingPrincipal({ thingName: deviceID, principal: registerCertificateResponse.certificateArn }).promise();
        }
        else if (searchResponse.things.length !== 1) {
            console.log("Inconsistent thing repo: More than one result for the same device ID (" + deviceID + ")");
        }
        else {
            const thing = searchResponse.things[0];
            const principalResponse = await iot.listThingPrincipals({ thingName: thing.thingName, maxResults: 25 }).promise();
            const principals = principalResponse.principals;
            for (const principal of principals) {
                const splitiedPrincipal = principal.split(":");
                const certificateID = splitiedPrincipal[splitiedPrincipal.length - 1].replace("cert/", "");
                const certificateResponse = await iot.describeCertificate({ certificateId: certificateID }).promise();
                const certPem = certificateResponse.certificateDescription.certificatePem;
                const cert = x509_1.Certificate.fromPEM(Buffer.from(certPem, "utf8"));
                if (chunk(cert.serialNumber, 2).join("-") === serialNumber) {
                    await iot.updateCertificate({ newStatus: status, certificateId: certificateID }).promise();
                    return;
                }
            }
            console.log("device does not have the certificate yet. Registering manually");
            const registerCertificateResponse = await iot.registerCertificate({ certificatePem: deviceCert, caCertificatePem: caCert, status: status }).promise();
            await iot.attachThingPrincipal({ thingName: deviceID, principal: registerCertificateResponse.certificateArn }).promise();
        }
    }
};
function chunk(str, n) {
    const ret = [];
    let i;
    let len;
    for (i = 0, len = str.length; i < len; i += n) {
        ret.push(str.substr(i, n));
    }
    return ret;
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiaW5kZXguanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyJpbmRleC50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7QUFBQSxxQ0FBNkI7QUFDN0IsNkNBQXdDO0FBQ3hDLHFDQUF3QztBQUV4QyxNQUFNLEdBQUcsR0FBRyxJQUFJLGFBQUcsRUFBRSxDQUFBO0FBRVIsUUFBQSxPQUFPLEdBQUcsS0FBSyxFQUFFLEtBQVUsRUFBRSxFQUFFO0lBQzFDLE9BQU8sQ0FBQyxHQUFHLENBQUMsS0FBSyxDQUFDLENBQUE7SUFFbEIsTUFBTSxtQkFBbUIsR0FBRyxJQUFJLHdCQUFVLENBQU0sS0FBSyxDQUFDLENBQUE7SUFFdEQsTUFBTSxRQUFRLEdBQUcsbUJBQW1CLENBQUMsSUFBSSxDQUFDLFNBQVMsQ0FBQTtJQUNuRCxNQUFNLFVBQVUsR0FBRyxNQUFNLENBQUMsSUFBSSxDQUFDLG1CQUFtQixDQUFDLElBQUksQ0FBQyxXQUFXLEVBQUUsUUFBUSxDQUFDLENBQUMsUUFBUSxDQUFDLE9BQU8sQ0FBQyxDQUFBO0lBQ2hHLE1BQU0sTUFBTSxHQUFHLE1BQU0sQ0FBQyxJQUFJLENBQUMsbUJBQW1CLENBQUMsSUFBSSxDQUFDLE9BQU8sRUFBRSxRQUFRLENBQUMsQ0FBQyxRQUFRLENBQUMsT0FBTyxDQUFDLENBQUE7SUFDeEYsTUFBTSxNQUFNLEdBQUcsbUJBQW1CLENBQUMsSUFBSSxDQUFDLE1BQU0sQ0FBQTtJQUM5QyxNQUFNLFlBQVksR0FBRyxtQkFBbUIsQ0FBQyxJQUFJLENBQUMsYUFBYSxDQUFBO0lBRTNELElBQUksTUFBTSxLQUFLLFFBQVEsSUFBSSxNQUFNLEtBQUssVUFBVSxJQUFJLE1BQU0sS0FBSyxTQUFTLEVBQUU7UUFDeEUsTUFBTSxjQUFjLEdBQUcsTUFBTSxHQUFHLENBQUMsV0FBVyxDQUFDLEVBQUUsV0FBVyxFQUFFLGFBQWEsUUFBUSxFQUFFLEVBQUUsQ0FBQyxDQUFDLE9BQU8sRUFBRSxDQUFBO1FBQ2hHLElBQUksY0FBYyxDQUFDLE1B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QUFFLEdBQVcsRUFBRSxDQUFTO0lBQ3BDLE1BQU0sR0FBRyxHQUFHLEVBQUUsQ0FBQTtJQUNkLElBQUksQ0FBQyxDQUFBO0lBQ0wsSUFBSSxHQUFHLENBQUE7SUFFUCxLQUFLLENBQUMsR0FBRyxDQUFDLEVBQUUsR0FBRyxHQUFHLEdBQUcsQ0FBQyxNQUFNLEVBQUUsQ0FBQyxHQUFHLEdBQUcsRUFBRSxDQUFDLElBQUksQ0FBQyxFQUFFO1FBQzdDLEdBQUcsQ0FBQyxJQUFJLENBQUMsR0FBRyxDQUFDLE1BQU0sQ0FBQyxDQUFDLEVBQUUsQ0FBQyxDQUFDLENBQUMsQ0FBQTtLQUMzQjtJQUVELE9BQU8sR0FBRyxDQUFBO0FBQ1osQ0FBQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IElvdCB9IGZyb20gXCJhd3Mtc2RrXCJcbmltcG9ydCB7IENsb3VkRXZlbnQgfSBmcm9tIFwiY2xvdWRldmVudHNcIlxuaW1wb3J0IHsgQ2VydGlmaWNhdGUgfSBmcm9tIFwiQGZpZG0veDUwOVwiXG5cbmNvbnN0IGlvdCA9IG5ldyBJb3QoKVxuXG5leHBvcnQgY29uc3QgaGFuZGxlciA9IGFzeW5jIChldmVudDogYW55KSA9PiB7XG4gIGNvbnNvbGUubG9nKGV2ZW50KVxuXG4gIGNvbnN0IHJlcXVlc3RlZENsb3VkRXZlbnQgPSBuZXcgQ2xvdWRFdmVudDxhbnk+KGV2ZW50KVxuXG4gIGNvbnN0IGRldmljZUlEID0gcmVxdWVzdGVkQ2xvdWRFdmVudC5kYXRhLmRldmljZV9pZFxuICBjb25zdCBkZXZpY2VDZXJ0ID0gQnVmZmVyLmZyb20ocmVxdWVzdGVkQ2xvdWRFdmVudC5kYXRhLmRldmljZV9jZXJ0LCBcImJhc2U2NFwiKS50b1N0cmluZyhcInV0Zi04XCIpXG4gIGNvbnN0IGNhQ2VydCA9IEJ1ZmZlci5mcm9tKHJlcXVlc3RlZENsb3VkRXZlbnQuZGF0YS5jYV9jZXJ0LCBcImJhc2U2NFwiKS50b1N0cmluZyhcInV0Zi04XCIpXG4gIGNvbnN0IHN0YXR1cyA9IHJlcXVlc3RlZENsb3VkRXZlbnQuZGF0YS5zdGF0dXNcbiAgY29uc3Qgc2VyaWFsTnVtYmVyID0gcmVxdWVzdGVkQ2xvdWRFdmVudC5kYXRhLnNlcmlhbF9udW1iZXJcblxuICBpZiAoc3RhdHVzID09PSBcIkFDVElWRVwiIHx8IHN0YXR1cyA9PT0gXCJJTkFDVElWRVwiIHx8IHN0YXR1cyA9PT0gXCJSRVZPS0VEXCIpIHtcbiAgICBjb25zdCBzZWFyY2hSZXNwb25zZSA9IGF3YWl0IGlvdC5zZWFyY2hJbmRleCh7IHF1ZXJ5U3RyaW5nOiBgdGhpbmdOYW1lOiR7ZGV2aWNlSUR9YCB9KS5wcm9taXNlKClcbiAgICBpZiAoc2VhcmNoUmVzcG9uc2UudGhpbmdzIS5sZW5ndGggPT09IDApIHtcbiAgICAgIGNvbnNvbGUubG9nKFwiTm8gcmVzdWx0cyB3aXRoIGRldmljZSBJRCAoXCIgKyBkZXZpY2VJRCArIFwiKS4gUmVnaXN0ZXJpbmcgZGV2aWNlXCIpXG4gICAgICBhd2FpdCBpb3QuY3JlYXRlVGhpbmcoeyB0aGluZ05hbWU6IGRldmljZUlEIH0pLnByb21pc2UoKVxuICAgICAgY29uc3QgcmVnaXN0ZXJDZXJ0aWZpY2F0ZVJlc3BvbnNlID0gYXdhaXQgaW90LnJlZ2lzdGVyQ2VydGlmaWNhdGUoeyBjZXJ0aWZpY2F0ZVBlbTogZGV2aWNlQ2VydCwgY2FDZXJ0aWZpY2F0ZVBlbTogY2FDZXJ0LCBzdGF0dXM6IHN0YXR1cyB9KS5wcm9taXNlKClcbiAgICAgIGF3YWl0IGlvdC5hdHRhY2hUaGluZ1ByaW5jaXBhbCh7IHRoaW5nTmFtZTogZGV2aWNlSUQsIHByaW5jaXBhbDogcmVnaXN0ZXJDZXJ0aWZpY2F0ZVJlc3BvbnNlLmNlcnRpZmljYXRlQXJuISB9KS5wcm9taXNlKClcbiAgICB9IGVsc2UgaWYgKHNlYXJjaFJlc3BvbnNlLnRoaW5ncyEubGVuZ3RoICE9PSAxKSB7XG4gICAgICBjb25zb2xlLmxvZyhcIkluY29uc2lzdGVudCB0aGluZyByZXBvOiBNb3JlIHRoYW4gb25lIHJlc3VsdCBmb3IgdGhlIHNhbWUgZGV2aWNlIElEIChcIiArIGRldmljZUlEICsgXCIpXCIpXG4gICAgfSBlbHNlIHtcbiAgICAgIGNvbnN0IHRoaW5nID0gc2VhcmNoUmVzcG9uc2UudGhpbmdzIVswXVxuICAgICAgY29uc3QgcHJpbmNpcGFsUmVzcG9uc2UgPSBhd2FpdCBpb3QubGlzdFRoaW5nUHJpbmNpcGFscyh7IHRoaW5nTmFtZTogdGhpbmcudGhpbmdOYW1lISwgbWF4UmVzdWx0czogMjUgfSkucHJvbWlzZSgpXG4gICAgICBjb25zdCBwcmluY2lwYWxzID0gcHJpbmNpcGFsUmVzcG9uc2UucHJpbmNpcGFsc1xuXG4gICAgICBmb3IgKGNvbnN0IHByaW5jaXBhbCBvZiBwcmluY2lwYWxzISkge1xuICAgICAgICBjb25zdCBzcGxpdGllZFByaW5jaXBhbCA9IHByaW5jaXBhbC5zcGxpdChcIjpcIilcbiAgICAgICAgY29uc3QgY2VydGlmaWNhdGVJRCA9IHNwbGl0aWVkUHJpbmNpcGFsW3NwbGl0aWVkUHJpbmNpcGFsLmxlbmd0aCAtIDFdLnJlcGxhY2UoXCJjZXJ0L1wiLCBcIlwiKVxuICAgICAgICBjb25zdCBjZXJ0aWZpY2F0ZVJlc3BvbnNlID0gYXdhaXQgaW90LmRlc2NyaWJlQ2VydGlmaWNhdGUoeyBjZXJ0aWZpY2F0ZUlkOiBjZXJ0aWZpY2F0ZUlEIH0pLnByb21pc2UoKVxuICAgICAgICBjb25zdCBjZXJ0UGVtID0gY2VydGlmaWNhdGVSZXNwb25zZS5jZXJ0aWZpY2F0ZURlc2NyaXB0aW9uIS5jZXJ0aWZpY2F0ZVBlbSFcbiAgICAgICAgY29uc3QgY2VydCA9IENlcnRpZmljYXRlLmZyb21QRU0oQnVmZmVyLmZyb20oY2VydFBlbSwgXCJ1dGY4XCIpKVxuXG4gICAgICAgIGlmIChjaHVuayhjZXJ0LnNlcmlhbE51bWJlciwgMikuam9pbihcIi1cIikgPT09IHNlcmlhbE51bWJlcikge1xuICAgICAgICAgIGF3YWl0IGlvdC51cGRhdGVDZXJ0aWZpY2F0ZSh7IG5ld1N0YXR1czogc3RhdHVzLCBjZXJ0aWZpY2F0ZUlkOiBjZXJ0aWZpY2F0ZUlEIH0pLnByb21pc2UoKVxuICAgICAgICAgIHJldHVyblxuICAgICAgICB9XG4gICAgICB9XG5cbiAgICAgIGNvbnNvbGUubG9nKFwiZGV2aWNlIGRvZXMgbm90IGhhdmUgdGhlIGNlcnRpZmljYXRlIHlldC4gUmVnaXN0ZXJpbmcgbWFudWFsbHlcIilcbiAgICAgIGNvbnN0IHJlZ2lzdGVyQ2VydGlmaWNhdGVSZXNwb25zZSA9IGF3YWl0IGlvdC5yZWdpc3RlckNlcnRpZmljYXRlKHsgY2VydGlmaWNhdGVQZW06IGRldmljZUNlcnQsIGNhQ2VydGlmaWNhdGVQZW06IGNhQ2VydCwgc3RhdHVzOiBzdGF0dXMgfSkucHJvbWlzZSgpXG4gICAgICBhd2FpdCBpb3QuYXR0YWNoVGhpbmdQcmluY2lwYWwoeyB0aGluZ05hbWU6IGRldmljZUlELCBwcmluY2lwYWw6IHJlZ2lzdGVyQ2VydGlmaWNhdGVSZXNwb25zZS5jZXJ0aWZpY2F0ZUFybiEgfSkucHJvbWlzZSgpXG4gICAgfVxuICB9XG59XG5cbmZ1bmN0aW9uIGNodW5rIChzdHI6IHN0cmluZywgbjogbnVtYmVyKSB7XG4gIGNvbnN0IHJldCA9IFtdXG4gIGxldCBpXG4gIGxldCBsZW5cblxuICBmb3IgKGkgPSAwLCBsZW4gPSBzdHIubGVuZ3RoOyBpIDwgbGVuOyBpICs9IG4pIHtcbiAgICByZXQucHVzaChzdHIuc3Vic3RyKGksIG4pKVxuICB9XG5cbiAgcmV0dXJuIHJldFxufVxuIl19