"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.handler = void 0;
const aws_sdk_1 = require("aws-sdk");
const cloudevents_1 = require("cloudevents");
const x509_1 = require("@fidm/x509");
const iot = new aws_sdk_1.Iot();
const sqs = new aws_sdk_1.SQS();
exports.handler = async (event) => {
    console.log(event);
    const requestParameters = event.detail.requestParameters;
    const newStatus = requestParameters.newStatus;
    const certificateId = requestParameters.certificateId;
    const describeCertResponse = await iot.describeCertificate({ certificateId: certificateId }).promise();
    console.log("caCertificateID" + describeCertResponse.certificateDescription.caCertificateId);
    console.log("certificateId" + certificateId);
    const describeCAResponse = await iot.describeCACertificate({ certificateId: describeCertResponse.certificateDescription.caCertificateId }).promise();
    const caCert = x509_1.Certificate.fromPEM(Buffer.from(describeCAResponse.certificateDescription.certificatePem, "utf8"));
    const cert = x509_1.Certificate.fromPEM(Buffer.from(describeCertResponse.certificateDescription.certificatePem, "utf8"));
    const deviceID = cert.subject.commonName;
    console.log("deviceID: [" + deviceID + "] newStatus:[" + newStatus + "]");
    const cloudEvent = new cloudevents_1.CloudEvent({
        type: "io.lamassu.iotcore.cert.updatestatus",
        id: "",
        source: "cloud-trail",
        time: new Date().toString(),
        specversion: "1.0",
        data: {
            caID: describeCertResponse.certificateDescription.caCertificateId,
            caName: caCert.subject.commonName,
            caSerialNumber: caCert.serialNumber,
            certificateID: certificateId,
            deviceID: deviceID
        }
    });
    try {
        const sqsResponse = await sqs.sendMessage({ QueueUrl: process.env.SQS_RESPONSE_QUEUE_URL, MessageBody: cloudEvent.toString() }).promise();
        console.log(sqsResponse);
    }
    catch (err) {
        console.log("error while sending SQS messgae", err);
    }
};
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiaW5kZXguanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyJpbmRleC50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7QUFBQSxxQ0FBa0M7QUFDbEMsNkNBQXdDO0FBQ3hDLHFDQUF3QztBQUV4QyxNQUFNLEdBQUcsR0FBRyxJQUFJLGFBQUcsRUFBRSxDQUFBO0FBQ3JCLE1BQU0sR0FBRyxHQUFHLElBQUksYUFBRyxFQUFFLENBQUE7QUFFUixRQUFBLE9BQU8sR0FBRyxLQUFLLEVBQUUsS0FBVSxFQUFFLEVBQUU7SUFDMUMsT0FBTyxDQUFDLEdBQUcsQ0FBQyxLQUFLLENBQUMsQ0FBQTtJQUNsQixNQUFNLGlCQUFpQixHQUFHLEtBQUssQ0FBQyxNQUFNLENBQUMsaUJBQWlCLENBQUE7SUFDeEQsTUFBTSxTQUFTLEdBQVcsaUJBQWlCLENBQUMsU0FBUyxDQUFBO0lBQ3JELE1BQU0sYUFBYSxHQUFXLGlCQUFpQixDQUFDLGFBQWEsQ0FBQTtJQUU3RCxNQUFNLG9CQUFvQixHQUFHLE1BQU0sR0FBRyxDQUFDLG1CQUFtQixDQUFDLEVBQUUsYUFBYSxFQUFFLGFBQWEsRUFBRSxDQUFDLENBQUMsT0FBTyxFQUFFLENBQUE7SUFFdEcsT0FBTyxDQUFDLEdBQUcsQ0FBQyxpQkFBaUIsR0FBRyxvQkFBb0IsQ0FBQyxzQkFBdUIsQ0FBQyxlQUFlLENBQUMsQ0FBQTtJQUM3RixPQUFPLENBQUMsR0FBRyxDQUFDLGVBQWUsR0FBRyxhQUFhLENBQUMsQ0FBQTtJQUU1QyxNQUFNLGtCQUFrQixHQUFHLE1BQU0sR0FBRyxDQUFDLHFCQUFxQixDQUFDLEVBQUUsYUFBYSxFQUFFLG9CQUFvQixDQUFDLHNCQUF1QixDQUFDLGVBQWdCLEVBQUUsQ0FBQyxDQUFDLE9BQU8sRUFBRSxDQUFBO0lBRXRKLE1BQU0sTUFBTSxHQUFHLGtCQUFXLENBQUMsT0FBTyxDQUFDLE1BQU0sQ0FBQyxJQUFJLENBQUMsa0JBQWtCLENBQUMsc0JBQXVCLENBQUMsY0FBZSxFQUFFLE1BQU0sQ0FBQyxDQUFDLENBQUE7SUFDbkgsTUFBTSxJQUFJLEdBQUcsa0JBQVcsQ0FBQyxPQUFPLENBQUMsTUFBTSxDQUFDLElBQUksQ0FBQyxvQkFBb0IsQ0FBQyxzQkFBdUIsQ0FBQyxjQUFlLEVBQUUsTUFBTSxDQUFDLENBQUMsQ0FBQTtJQUVuSCxNQUFNLFFBQVEsR0FBRyxJQUFJLENBQUMsT0FBTyxDQUFDLFVBQVUsQ0FBQTtJQUN4QyxPQUFPLENBQUMsR0FBRyxDQUFDLGFBQWEsR0FBRyxRQUFRLEdBQUcsZUFBZSxHQUFHLFNBQVMsR0FBRyxHQUFHLENBQUMsQ0FBQTtJQUV6RSxNQUFNLFVBQVUsR0FBRyxJQUFJLHdCQUFVLENBQUM7UUFDaEMsSUFBSSxFQUFFLHNDQUFzQztRQUM1QyxFQUFFLEVBQUUsRUFBRTtRQUNOLE1BQU0sRUFBRSxhQUFhO1FBQ3JCLElBQUksRUFBRSxJQUFJLElBQUksRUFBRSxDQUFDLFFBQVEsRUFBRTtRQUMzQixXQUFXLEVBQUUsS0FBSztRQUNsQixJQUFJLEVBQUU7WUFDSixJQUFJLEVBQUUsb0JBQW9CLENBQUMsc0JBQXVCLENBQUMsZUFBZTtZQUNsRSxNQUFNLEVBQUUsTUFBTSxDQUFDLE9BQU8sQ0FBQyxVQUFVO1lBQ2pDLGNBQWMsRUFBRSxNQUFNLENBQUMsWUFBWTtZQUNuQyxhQUFhLEVBQUUsYUFBYTtZQUM1QixRQUFRLEVBQUUsUUFBUTtTQUNuQjtLQUNGLENBQUMsQ0FBQTtJQUNGLElBQUk7UUFDRixNQUFNLFdBQVcsR0FBRyxNQUFNLEdBQUcsQ0FBQyxXQUFXLENBQUMsRUFBRSxRQUFRLEVBQUUsT0FBTyxDQUFDLEdBQUcsQ0FBQyxzQkFBdUIsRUFBRSxXQUFXLEVBQUUsVUFBVSxDQUFDLFFBQVEsRUFBRSxFQUFFLENBQUMsQ0FBQyxPQUFPLEVBQUUsQ0FBQTtRQUMxSSxPQUFPLENBQUMsR0FBRyxDQUFDLFdBQVcsQ0FBQyxDQUFBO0tBQ3pCO0lBQUMsT0FBTyxHQUFHLEVBQUU7UUFDWixPQUFPLENBQUMsR0FBRyxDQUFDLGlDQUFpQyxFQUFFLEdBQUcsQ0FBQyxDQUFBO0tBQ3BEO0FBQ0gsQ0FBQyxDQUFBIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgSW90LCBTUVMgfSBmcm9tIFwiYXdzLXNka1wiXG5pbXBvcnQgeyBDbG91ZEV2ZW50IH0gZnJvbSBcImNsb3VkZXZlbnRzXCJcbmltcG9ydCB7IENlcnRpZmljYXRlIH0gZnJvbSBcIkBmaWRtL3g1MDlcIlxuXG5jb25zdCBpb3QgPSBuZXcgSW90KClcbmNvbnN0IHNxcyA9IG5ldyBTUVMoKVxuXG5leHBvcnQgY29uc3QgaGFuZGxlciA9IGFzeW5jIChldmVudDogYW55KSA9PiB7XG4gIGNvbnNvbGUubG9nKGV2ZW50KVxuICBjb25zdCByZXF1ZXN0UGFyYW1ldGVycyA9IGV2ZW50LmRldGFpbC5yZXF1ZXN0UGFyYW1ldGVyc1xuICBjb25zdCBuZXdTdGF0dXM6IHN0cmluZyA9IHJlcXVlc3RQYXJhbWV0ZXJzLm5ld1N0YXR1c1xuICBjb25zdCBjZXJ0aWZpY2F0ZUlkOiBzdHJpbmcgPSByZXF1ZXN0UGFyYW1ldGVycy5jZXJ0aWZpY2F0ZUlkXG5cbiAgY29uc3QgZGVzY3JpYmVDZXJ0UmVzcG9uc2UgPSBhd2FpdCBpb3QuZGVzY3JpYmVDZXJ0aWZpY2F0ZSh7IGNlcnRpZmljYXRlSWQ6IGNlcnRpZmljYXRlSWQgfSkucHJvbWlzZSgpXG5cbiAgY29uc29sZS5sb2coXCJjYUNlcnRpZmljYXRlSURcIiArIGRlc2NyaWJlQ2VydFJlc3BvbnNlLmNlcnRpZmljYXRlRGVzY3JpcHRpb24hLmNhQ2VydGlmaWNhdGVJZClcbiAgY29uc29sZS5sb2coXCJjZXJ0aWZpY2F0ZUlkXCIgKyBjZXJ0aWZpY2F0ZUlkKVxuXG4gIGNvbnN0IGRlc2NyaWJlQ0FSZXNwb25zZSA9IGF3YWl0IGlvdC5kZXNjcmliZUNBQ2VydGlmaWNhdGUoeyBjZXJ0aWZpY2F0ZUlkOiBkZXNjcmliZUNlcnRSZXNwb25zZS5jZXJ0aWZpY2F0ZURlc2NyaXB0aW9uIS5jYUNlcnRpZmljYXRlSWQhIH0pLnByb21pc2UoKVxuXG4gIGNvbnN0IGNhQ2VydCA9IENlcnRpZmljYXRlLmZyb21QRU0oQnVmZmVyLmZyb20oZGVzY3JpYmVDQVJlc3BvbnNlLmNlcnRpZmljYXRlRGVzY3JpcHRpb24hLmNlcnRpZmljYXRlUGVtISwgXCJ1dGY4XCIpKVxuICBjb25zdCBjZXJ0ID0gQ2VydGlmaWNhdGUuZnJvbVBFTShCdWZmZXIuZnJvbShkZXNjcmliZUNlcnRSZXNwb25zZS5jZXJ0aWZpY2F0ZURlc2NyaXB0aW9uIS5jZXJ0aWZpY2F0ZVBlbSEsIFwidXRmOFwiKSlcblxuICBjb25zdCBkZXZpY2VJRCA9IGNlcnQuc3ViamVjdC5jb21tb25OYW1lXG4gIGNvbnNvbGUubG9nKFwiZGV2aWNlSUQ6IFtcIiArIGRldmljZUlEICsgXCJdIG5ld1N0YXR1czpbXCIgKyBuZXdTdGF0dXMgKyBcIl1cIilcblxuICBjb25zdCBjbG91ZEV2ZW50ID0gbmV3IENsb3VkRXZlbnQoe1xuICAgIHR5cGU6IFwiaW8ubGFtYXNzdS5pb3Rjb3JlLmNlcnQudXBkYXRlc3RhdHVzXCIsXG4gICAgaWQ6IFwiXCIsXG4gICAgc291cmNlOiBcImNsb3VkLXRyYWlsXCIsXG4gICAgdGltZTogbmV3IERhdGUoKS50b1N0cmluZygpLFxuICAgIHNwZWN2ZXJzaW9uOiBcIjEuMFwiLFxuICAgIGRhdGE6IHtcbiAgICAgIGNhSUQ6IGRlc2NyaWJlQ2VydFJlc3BvbnNlLmNlcnRpZmljYXRlRGVzY3JpcHRpb24hLmNhQ2VydGlmaWNhdGVJZCxcbiAgICAgIGNhTmFtZTogY2FDZXJ0LnN1YmplY3QuY29tbW9uTmFtZSxcbiAgICAgIGNhU2VyaWFsTnVtYmVyOiBjYUNlcnQuc2VyaWFsTnVtYmVyLFxuICAgICAgY2VydGlmaWNhdGVJRDogY2VydGlmaWNhdGVJZCxcbiAgICAgIGRldmljZUlEOiBkZXZpY2VJRFxuICAgIH1cbiAgfSlcbiAgdHJ5IHtcbiAgICBjb25zdCBzcXNSZXNwb25zZSA9IGF3YWl0IHNxcy5zZW5kTWVzc2FnZSh7IFF1ZXVlVXJsOiBwcm9jZXNzLmVudi5TUVNfUkVTUE9OU0VfUVVFVUVfVVJMISwgTWVzc2FnZUJvZHk6IGNsb3VkRXZlbnQudG9TdHJpbmcoKSB9KS5wcm9taXNlKClcbiAgICBjb25zb2xlLmxvZyhzcXNSZXNwb25zZSlcbiAgfSBjYXRjaCAoZXJyKSB7XG4gICAgY29uc29sZS5sb2coXCJlcnJvciB3aGlsZSBzZW5kaW5nIFNRUyBtZXNzZ2FlXCIsIGVycilcbiAgfVxufVxuIl19